tinymce.PluginManager.add("contaonewslink", function (editor) {
    // Add a button that opens a window
    editor.addButton('contaonewslink', {
        text: 'News Link',
        icon: false,
        onclick: function () {
            // Get newsarchive-data from tinyCustom.php
            var aNewsData = tinyMCE.activeEditor.getParam('news_data');

            /**
             * This will open a second modal for picking the news item
             * @param archive_id
             */
            function openNewsPicker(archive_id, popup){
                popup.close(window);
                editor.windowManager.open({
                    title: 'Example plugin',
                    body: [
                        {
                            type: 'listbox',
                            name: 'newsList',
                            label: 'News-Beitrag auswaehlen:',
                            values: aNewsData['news']['archive_' + archive_id],
                            // Default value is the first item
                            value: aNewsData['news']['archive_' + archive_id][0]['value']
                        }

                    ],
                    onselect: function (e) {
                        //
                    },
                    onsubmit: function (e) {
                        // Insert content when the window form is submitted
                        if (e.data.newsList > 0) {
                            var selectedContent = tinymce.activeEditor.selection.getContent({format: 'text'}).trim();
                            if(selectedContent != '')
                            {
                                tinymce.activeEditor.selection.setContent('{{news_open::' + e.data.newsList + '}}' + selectedContent + '{{link_close}} ');
                            }else{
                                var text = 'Hier klicken!'
                                editor.insertContent('{{news_open::' + e.data.newsList + '}}' + text + '{{link_close}} ');
                            }
                        }
                    }

                });
            }

            editor.windowManager.open({
                title: 'Example plugin',
                body: [
                    {
                        type: 'listbox',
                        name: 'newsarchivesList',
                        label: 'Archiv auswaehlen:',
                        values: aNewsData['archives'],
                        //value: -1
                    }

                ],
                onselect: function (e) {
                    var selected_newsarchive_id = e.control['_value'];
                    // Open Newspicker modal
                    openNewsPicker(selected_newsarchive_id, parent.tinyMCE.activeEditor.windowManager);
                },
                onsubmit: function (e) {
                    var archive_id = e.data.newsarchivesList;
                    // Open Newspicker modal
                    openNewsPicker(archive_id, parent.tinyMCE.activeEditor.windowManager);
                }
            });
        }
    });
});