/**
 * Get options from tinyCustom.php
 * @param pid
 * @returns {string}
 */
function getNewsOptions(pid) {
    var aNewsData = tinyMCE.activeEditor.getParam('news_data');
    var html = '';
    Array.each(aNewsData['news']['archive_' + pid], function (aNews) {
        html += '<option value="' + aNews['value'] + '">' + aNews['text'] + '</option>';
    });

    return html;

}

// Add button to the toolbar
tinymce.PluginManager.add("contaonewslink", function (editor) {
    // Add a button that opens a window
    editor.addButton('contaonewslink', {
        text: 'News Link',
        icon: false,
        onclick: function () {

            var aNewsData = tinyMCE.activeEditor.getParam('news_data');
            var html = '<div style="padding:10px">';
            html += '<h3>Newsarchiv ausw채hlen</h3>';
            html += '<select id="newsarchives" style="width: 90%; margin-bottom: 30px;" class="tl_select tl_chosen">';
            Array.each(aNewsData['archives'], function (aArchive) {
                html = html + '<option value="' + aArchive['value'] + '">' + aArchive['text'] + '</option>';
            });
            html += '</select><p></p>';
            var pid = aNewsData['archives'][0]['value'];
            html += '<h3>Newsbeitrag ausw채hlen</h3>';
            html += '<select id="newslist" style="width: 90%; margin-bottom: 30px;" name="newlist" class="tl_select tl_chosen">';

            html += getNewsOptions(pid);
            html += '</select>';
            html += '</div>';


            // Open modal window
            var SM = new SimpleModal({
                "width": 640,
                'draggable': false,
                'overlayOpacity': .5,
                'onShow': function () {
                    document.body.setStyle('overflow', 'hidden');
                },
                'onHide': function () {
                    document.body.setStyle('overflow', 'auto');
                }
            });


            // Add button and add event to the button
            SM.addButton("ausw채hlen", "btn primary", function () {
                var id = $('newslist').getSelected().get('value');
                // Insert content when the window form is submitted
                if (id > 0) {
                    var selectedContent = tinymce.activeEditor.selection.getContent({format: 'text'}).trim();
                    if (selectedContent != '') {
                        tinymce.activeEditor.selection.setContent('<a href="{{news_url::' + id + '}}">' + selectedContent + '</a> ');
                    } else {
                        var text = 'Hier klicken!';
                        editor.insertContent('<a href="{{news_url::' + id + '}}">' + text + '</a> ');
                    }
                }
                this.hide();
            });

            // Add cancel button
            SM.addButton("Cancel", "btn");

            SM.show({
                "title": "Newsartikel ausw채hlen",
                "contents": html
            });

            // Remove the ok-button
            $$('.simple-modal-footer a[title="OK"]').destroy();

            // Add onchange event
            document.id('newsarchives').addEvent('change', function () {
                var pid = this.getSelected().get("value");
                $$('#newslist option').destroy();
                $('newslist').appendHTML(getNewsOptions(pid));
            });
        }
    });
});
